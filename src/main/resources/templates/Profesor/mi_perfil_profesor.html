<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Profesor - Mi Perfil | Eduverse</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <style>
        .profile-card {
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .profile-table .table> :not(caption)>*>* {
            padding: 0.8rem 1rem;
        }

        .profile-table th {
            width: 35%;
            font-weight: 600;
            background-color: #f8f9fa;
        }
    </style>
</head>

<body>
    <header>
        <div class="menu-toggle text-white">&#9776;</div>
        <div class="logo fw-bold">Eduverse</div>
        <div class="user">
            <div class="dropdown">
                <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton"
                    data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-person-circle me-1"></i>
                    <span th:text="${profesor.nombreCompleto}">Profesor Demo</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li>
                        <a th:href="@{/profesor/perfil/{id}(id=${profesorId})}" class="dropdown-item"><i
                                class="bi bi-person-badge"></i> Mi Perfil</a>
                    </li>
                    <li>
                        <a th:href="@{/login}" class="dropdown-item"><i class="bi bi-box-arrow-right"></i> Cerrar
                            sesión</a>
                    </li>
                </ul>
            </div>
        </div>
    </header>

    <div class="sidebar bg-dark" id="sidebar">
        <a th:href="@{/profesor/cursos/{id}(id=${profesorId})}"><i class="bi bi-journals"></i><span>Mis
                Cursos</span><small>Cursos</small></a>
        <a th:href="@{/profesor/tareas/{id}(id=${profesorId})}"><i class="bi bi-list-task"></i><span>Mis
                Tareas</span><small>Tareas</small></a>
        <a th:href="@{/profesor/alumnos/{id}(id=${profesorId})}"><i class="bi bi-people-fill"></i><span>Mis
                Alumnos</span><small>Alumnos</small></a>
        <a th:href="@{/profesor/notas/{id}(id=${profesorId})}"><i class="bi bi-bar-chart-line-fill"></i><span>Mis
                Notas</span><small>Notas</small></a>
        <a th:href="@{/profesor/perfil/{id}/avisos(id=${profesorId})}"><i class="bi bi-megaphone-fill"></i><span>Avisos</span><small>Avisos</small></a>
        <a th:href="@{/profesor/perfil/{id}(id=${profesorId})}" class="active-link"><i
                class="bi bi-person-fill"></i><span>Mi Perfil</span><small>Perfil</small></a>
    </div>

    <div class="overlay" id="overlay"></div>

    <div class="content p-4" id="content">
        <h1 class="fw-bold fs-3 mb-4">
            <i class="bi bi-person-fill me-2"></i> Mi Perfil
        </h1>

        <div class="row">
            <div class="col-lg-4 col-md-5 text-center mb-4">
                <div class="profile-card p-4 bg-light">
                    <img th:if="${profesor.fotoUrl}" th:src="@{${profesor.fotoUrl}}" alt="Foto de Perfil"
                        class="rounded-circle border border-primary p-1"
                        style="width: 120px; height: 120px; object-fit: cover" />

                    <i th:unless="${profesor.fotoUrl}" class="bi bi-person-bounding-box text-muted" id="profile-picture"
                        style="font-size: 8rem"></i>

                    <h2 class="fs-4 fw-bold mt-3" th:text="${profesor.nombreCompleto}"></h2>
                    <p class="text-muted" th:text="${profesor.codigoProfesor}"></p>

                    <button type="button" class="btn btn-warning mt-3 w-100" data-bs-toggle="modal"
                        data-bs-target="#cambioClaveModal">
                        <i class="bi bi-key-fill me-1"></i> Cambiar Contraseña
                    </button>

                    <form th:action="@{/profesor/perfil/{profesorId}/actualizar-foto(profesorId=${profesorId})}" method="post"
                        th:object="${fotoDTO}" enctype="multipart/form-data" id="photo-upload-form">
                        <input type="file" id="photo-input" th:field="*{foto}" accept="image/*" style="display: none" />

                        <button type="button" class="btn btn-outline-primary mt-2 w-100" id="trigger-photo-upload">
                            <i class="bi bi-camera-fill me-1"></i> Actualizar Foto
                        </button>

                        <div th:if="${#fields.hasErrors('foto')}" class="text-danger small mt-1" th:errors="*{foto}">
                            Error de archivo
                        </div>
                    </form>
                </div>
            </div>

            <div class="col-lg-8 col-md-7">
                <div class="profile-card p-4">
                    <h3 class="fs-5 fw-semibold mb-3 border-bottom pb-2">
                        Información Institucional
                    </h3>

                    <div class="profile-table">
                        <table class="table table-bordered mb-0">
                            <tbody>
                                <tr>
                                    <th>Nombre Completo</th>
                                    <td th:text="${profesor.nombreCompleto}"></td>
                                </tr>
                                <tr>
                                    <th>Código de Profesor</th>
                                    <td th:text="${profesor.codigoProfesor}"></td>
                                </tr>
                                <tr>
                                    <th>Correo Institucional</th>
                                    <td th:text="${profesor.correo}"></td>
                                </tr>
                                <tr>
                                    <th>Especialidad</th>
                                    <td>Matemática (Simulación)</td>
                                </tr>
                                <tr>
                                    <th>Antigüedad</th>
                                    <td>Desde 2015 (Simulación)</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="cambioClaveModal" tabindex="-1" aria-labelledby="cambioClaveModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form th:action="@{/profesor/perfil/{id}/cambiar-clave(id=${profesorId})}" method="post">
                    <div class="modal-header bg-warning text-dark">
                        <h5 class="modal-title" id="cambioClaveModalLabel">
                            <i class="bi bi-key-fill me-1"></i> Cambiar Contraseña
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        
                        <div th:if="${error}" class="alert alert-danger" role="alert">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            <span th:text="${error}">Mensaje de error.</span>
                        </div>
                        <div th:if="${mensaje}" class="alert alert-success" role="alert">
                            <i class="bi bi-check-circle-fill me-2"></i>
                            <span th:text="${mensaje}">Mensaje de éxito.</span>
                        </div>

                        <p class="text-muted small">
                            Para cambiar tu contraseña, primero ingresa tu contraseña actual
                            para verificar tu identidad.
                        </p>

                        <div class="mb-3">
                            <label for="contrasenaAnterior" class="form-label">Contraseña Anterior</label>
                            <input type="password" class="form-control" id="contrasenaAnterior"
                                name="contrasenaAnterior" required />
                        </div>

                        <div class="mb-3">
                            <label for="nuevaClave" class="form-label">Nueva Contraseña</label>
                            <input type="password" class="form-control" id="nuevaClave" name="nuevaClave" required
                                minlength="4" />
                        </div>
                        <div class="mb-3">
                            <label for="confirmarClave" class="form-label">Confirmar Nueva Contraseña</label>
                            <input type="password" class="form-control" id="confirmarClave" name="confirmarClave"
                                required minlength="4" />
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-warning">
                            Guardar Cambios
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <footer class="bg-dark text-white text-center p-3 mt-4">
        <p class="mb-0">
            © 2024 Eduverse - Portal Escolar | Contacto: soporte@eduverse.com
        </p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/js/script.js}"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Lógica para el manejo de la foto (si se implementa)
            const triggerButton = document.getElementById("trigger-photo-upload");
            const fileInput = document.getElementById("photo-input");
            const form = document.getElementById("photo-upload-form");

            triggerButton.addEventListener("click", function () {
                fileInput.click();
            });

            fileInput.addEventListener("change", function () {
                if (this.files.length > 0) {
                    form.submit();
                }
            });
            
            // Lógica para reabrir el modal con mensajes (Error o Éxito)
            const hasError = '[[${error}]]'.trim() !== ''; 
            const hasSuccess = '[[${mensaje}]]'.trim() !== ''; 
            
            if (hasError || hasSuccess) {
                setTimeout(function() {
                    const cambioClaveModal = new bootstrap.Modal(document.getElementById('cambioClaveModal'));
                    cambioClaveModal.show();
                    
                    if (hasSuccess) {
                         setTimeout(function() {
                            cambioClaveModal.hide();
                        }, 3000); 
                    }
                }, 100); 
            }
        });
    </script>
    
</body>

</html>